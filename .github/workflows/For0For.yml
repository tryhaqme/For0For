name: For0For

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Enter your target!'
        required: false

jobs:
  For0For:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: assign target and fetch files
      id: assign-target
      run: |
        if [ -n "${{ github.event.inputs.target_url }}" ]; then
          echo "TARGET=${{ github.event.inputs.target_url }}" >> $GITHUB_ENV
        else
          echo "TARGET=$(curl -s https://github.com/arkadiyt/bounty-targets-data/raw/refs/heads/main/data/wildcards.txt | shuf -n 1)" >> $GITHUB_ENV
        fi
        
        echo "Selected target: ${{ env.TARGET }}"
        
        wget -qO- "https://web.archive.org/cdx/search/cdx?url=${{ env.TARGET }}/*&collapse=urlkey&output=text&fl=original&filter=original:.*\.(sql|db|backup|yml|yaml|ini|csv|config|crt|pem|key|asc)$" | \
        while read file; do 
          echo "https://web.archive.org/web/*/$file" >> files.txt
        done
        
        touch files.txt

    - name: Count file exts
      run: |
        if [ -s files.txt ]; then
          awk -F. '{print $NF}' files.txt | sort | uniq -c > ext-counts.txt
        else
          echo "No files found"
        fi

    - name: Notify Discord
      env:
        WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        if [ -s files.txt ] && [ $(cat files.txt | wc -l) -gt 0 ]; then
          file_count=$(cat files.txt | wc -l)
          extension_counts=$(awk '{print $2 ": " $1}' ext-counts.txt | tr '\n' '\n')
          target_domain=$(echo "${{ env.TARGET }}" | awk -F/ '{print $3}')
          curl -H "Content-Type: application/json" -X POST -d "{\"content\": \"Found $file_count high-critic files of $target_domain! \n↓ Found exts ↓ \n$extension_counts\"}" $WEBHOOK_URL
        fi
